<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω Bucket</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.1489.0/aws-sdk.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f0f4f8; color: #333; }
    h2 { margin-bottom: 10px; }
    .btn { background: #2563eb; color: white; padding: 6px 12px; margin: 5px; border: none; border-radius: 6px; cursor: pointer; }
    .btn:hover { background: #1d4ed8; }
    .btn-small { padding: 3px 8px; font-size: 0.9em; }
    .btn-del { background: #dc2626; }
    .btn-del:hover { background: #b91c1c; }
    .file-list { margin-top: 20px; }
    .file-item { padding: 6px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
    .file-actions button { margin-left: 5px; }
  </style>
</head>
<body>

  <h2>üìÇ Qu·∫£n l√Ω Bucket</h2>

  <input type="file" id="fileInput" multiple>
  <button class="btn" onclick="uploadFiles()">‚¨ÜÔ∏è Upload</button>
  <br><br>

  <button class="btn" onclick="downloadAllAsZip()">‚¨áÔ∏è T·∫£i t·∫•t c·∫£ (ZIP)</button>
  <button class="btn" onclick="downloadAllImagesAsZip()">‚¨áÔ∏è T·∫£i to√†n b·ªô ·∫£nh (ZIP)</button>
  <button class="btn" onclick="downloadAllImagesDirect()">‚¨áÔ∏è T·∫£i to√†n b·ªô ·∫£nh (1 l·∫ßn, kh√¥ng ZIP)</button>

  <div class="file-list" id="fileList"></div>

<script>
  // ‚öôÔ∏è Config
  const bucket = "xinghui";
  const endpoint = "s3.cloudfly.vn";
  const accessKeyId = "N12TIFK5L059IK15QPO9";
  const secretAccessKey = "xqFsKI7fBDrlX6bL2mkDmrAuzTUMrneJbcOUbrTe";

  AWS.config.update({
    accessKeyId,
    secretAccessKey,
    endpoint: new AWS.Endpoint(endpoint),
    s3ForcePathStyle: true,
    region: "ap-southeast-1"
  });

  const s3 = new AWS.S3();

  // üìå Upload nhi·ªÅu file
  function uploadFiles() {
    const files = document.getElementById("fileInput").files;
    if (!files.length) return alert("Ch·ªçn file ƒë·ªÉ upload!");

    Array.from(files).forEach(file => {
      const params = { Bucket: bucket, Key: file.name, Body: file };
      s3.upload(params, (err) => {
        if (err) alert("‚ùå L·ªói upload: " + err);
        else loadFileList();
      });
    });
  }

  // üìå Load danh s√°ch file
  function loadFileList() {
    s3.listObjectsV2({ Bucket: bucket }, (err, data) => {
      if (err) return alert("Kh√¥ng th·ªÉ load danh s√°ch: " + err);
      const fileList = document.getElementById("fileList");
      fileList.innerHTML = "";

      data.Contents.forEach(obj => {
        const item = document.createElement("div");
        item.className = "file-item";
        const url = `https://${bucket}.${endpoint}/${encodeURIComponent(obj.Key)}`;
        item.innerHTML = `
          üìÑ <a href="${url}" target="_blank">${obj.Key}</a>
          <div class="file-actions">
            <button class="btn btn-small" onclick="downloadFile('${obj.Key}')">‚¨áÔ∏è T·∫£i v·ªÅ m√°y</button>
            <button class="btn btn-small btn-del" onclick="deleteFile('${obj.Key}')">üóëÔ∏è X√≥a</button>
          </div>`;
        fileList.appendChild(item);
      });
    });
  }

  // üìå T·∫£i 1 file (fetch + FileSaver)
  async function downloadFile(key) {
    try {
      const url = `https://${bucket}.${endpoint}/${encodeURIComponent(key)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("L·ªói t·∫£i file");
      const blob = await res.blob();
      saveAs(blob, key.split("/").pop());
    } catch (e) {
      alert("‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c file: " + e);
    }
  }

  // üìå X√≥a file
  function deleteFile(key) {
    if (!confirm("X√≥a file " + key + "?")) return;
    s3.deleteObject({ Bucket: bucket, Key: key }, (err) => {
      if (err) alert("‚ùå L·ªói x√≥a: " + err);
      else loadFileList();
    });
  }

  // üìå T·∫£i t·∫•t c·∫£ file th√†nh ZIP
  async function downloadAllAsZip() {
    s3.listObjectsV2({ Bucket: bucket }, async (err, data) => {
      if (err) return alert("Kh√¥ng th·ªÉ l·∫•y danh s√°ch: " + err);
      const zip = new JSZip();

      for (let obj of data.Contents) {
        const url = `https://${bucket}.${endpoint}/${encodeURIComponent(obj.Key)}`;
        try {
          const res = await fetch(url);
          if (res.ok) {
            const blob = await res.blob();
            zip.file(obj.Key, blob);
          }
        } catch {}
      }

      const content = await zip.generateAsync({ type: "blob" });
      saveAs(content, "all_files.zip");
    });
  }

  // üìå T·∫£i to√†n b·ªô ·∫£nh th√†nh ZIP
  async function downloadAllImagesAsZip() {
    s3.listObjectsV2({ Bucket: bucket }, async (err, data) => {
      if (err) return alert("Kh√¥ng th·ªÉ l·∫•y danh s√°ch: " + err);
      const zip = new JSZip();
      const folder = zip.folder("images");

      const imageExts = [".jpg", ".jpeg", ".png", ".gif", ".webp"];
      const images = data.Contents.filter(obj =>
        imageExts.some(ext => obj.Key.toLowerCase().endsWith(ext))
      );

      for (let obj of images) {
        const url = `https://${bucket}.${endpoint}/${encodeURIComponent(obj.Key)}`;
        try {
          const res = await fetch(url);
          if (res.ok) {
            const blob = await res.blob();
            folder.file(obj.Key, blob);
          }
        } catch {}
      }

      const content = await zip.generateAsync({ type: "blob" });
      saveAs(content, "all_images.zip");
    });
  }

  // üìå T·∫£i to√†n b·ªô ·∫£nh tr·ª±c ti·∫øp (kh√¥ng ZIP)
  function downloadAllImagesDirect() {
    s3.listObjectsV2({ Bucket: bucket }, async (err, data) => {
      if (err) return alert("Kh√¥ng th·ªÉ l·∫•y danh s√°ch: " + err);
      const imageExts = [".jpg", ".jpeg", ".png", ".gif", ".webp"];
      const images = data.Contents.filter(obj =>
        imageExts.some(ext => obj.Key.toLowerCase().endsWith(ext))
      );

      for (let i = 0; i < images.length; i++) {
        const obj = images[i];
        try {
          const url = `https://${bucket}.${endpoint}/${encodeURIComponent(obj.Key)}`;
          const res = await fetch(url);
          if (!res.ok) continue;
          const blob = await res.blob();
          saveAs(blob, obj.Key.split("/").pop());
          await new Promise(r => setTimeout(r, 800)); // ngh·ªâ 0.8s gi·ªØa c√°c file
        } catch {}
      }
    });
  }

  // T·∫£i danh s√°ch l·∫ßn ƒë·∫ßu
  loadFileList();
</script>
</body>
</html>
