<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Upload & Qu·∫£n l√Ω File</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: "Segoe UI", Tahoma, sans-serif; margin: 0; padding: 20px; background: #f9fafb; }
    h2 { color: #222; text-align: center; margin-bottom: 20px; }
    .container { max-width: 700px; margin: auto; }
    .btn {
      display: inline-block; padding: 10px 16px; border: none; border-radius: 6px;
      font-size: 15px; cursor: pointer; margin: 5px 0; transition: 0.3s;
    }
    .btn-upload { background: #4caf50; color: white; width: 100%; }
    .btn-upload:hover { background: #45a049; }
    .btn-zip { background: #0077cc; color: white; width: 100%; }
    .btn-zip:hover { background: #005fa3; }
    input[type=file] { margin: 15px 0; width: 100%; }
    .file-block {
      background: white; margin: 10px 0; padding: 12px; border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .progress { margin: 8px 0; background: #eee; border-radius: 8px; height: 20px; width: 100%; }
    .bar { height: 100%; background: linear-gradient(90deg,#4caf50,#81c784); width: 0%; color: white; text-align: center; font-size: 12px; border-radius: 8px; }
    .file-list { margin-top: 20px; }
    .file-actions button {
      margin: 3px; padding: 6px 10px; font-size: 13px; border-radius: 5px; cursor: pointer;
    }
    .btn-small { font-size: 13px; }
    .btn-download { background: #28a745; color: #fff; }
    .btn-rename { background: #ff9800; color: #fff; }
    .btn-del { background: #e53935; color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <h2>üì§ Upload & Qu·∫£n l√Ω File</h2>

    <input type="file" id="fileInput" multiple>
    <button class="btn btn-upload" onclick="uploadFiles()">‚¨ÜÔ∏è B·∫Øt ƒë·∫ßu Upload</button>

    <button class="btn btn-zip" onclick="downloadAllAsZip()">‚¨áÔ∏è T·∫£i t·∫•t c·∫£ (ZIP)</button>
    <button class="btn btn-zip" onclick="downloadAllImagesZip()">‚¨áÔ∏è T·∫£i to√†n b·ªô ·∫£nh (ZIP)</button>
    <button class="btn btn-zip" onclick="downloadAllImagesDirect()">‚¨áÔ∏è T·∫£i to√†n b·ªô ·∫£nh (1 l·∫ßn, kh√¥ng ZIP)</button>

    <div id="progressContainer"></div>
    <div id="fileList" class="file-list"></div>
  </div>

  <!-- AWS SDK -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.1420.0/aws-sdk.min.js"></script>
  <!-- JSZip + FileSaver -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    // ‚ö†Ô∏è Thay key/bucket/endpoint b·∫±ng c·ªßa b·∫°n
    const accessKey = "N12TIFK5L059IK15QPO9";
    const secretKey = "xqFsKI7fBDrlX6bL2mkDmrAuzTUMrneJbcOUbrTe";
    const bucket = "xinghui";
    const endpoint = "s3.cloudfly.vn";

    AWS.config.update({
      accessKeyId: accessKey,
      secretAccessKey: secretKey,
      region: "ap-southeast-1",
      s3ForcePathStyle: true,
    });

    const s3 = new AWS.S3({ endpoint: new AWS.Endpoint(endpoint) });

    // Upload file
    function uploadFiles() {
      const files = document.getElementById("fileInput").files;
      const container = document.getElementById("progressContainer");
      container.innerHTML = "";

      if (files.length === 0) {
        alert("Vui l√≤ng ch·ªçn file ƒë·ªÉ upload!");
        return;
      }

      Array.from(files).forEach(file => {
        const safeId = file.name.replace(/[^a-z0-9]/gi,'_');
        const wrapper = document.createElement("div");
        wrapper.className = "file-block";
        wrapper.innerHTML = `<strong>${file.name}</strong>
          <div class="progress"><div class="bar" id="bar-${safeId}">0%</div></div>`;
        container.appendChild(wrapper);

        const uniqueKey = Date.now() + "-" + file.name;
        const params = {
          Bucket: bucket,
          Key: uniqueKey,
          Body: file,
          ContentType: file.type || "application/octet-stream",
          ACL: "public-read"
        };

        s3.upload(params)
          .on("httpUploadProgress", evt => {
            const percent = Math.round((evt.loaded / evt.total) * 100);
            const bar = document.getElementById(`bar-${safeId}`);
            bar.style.width = percent + "%";
            bar.textContent = percent + "%";
          })
          .send((err, data) => {
            if (err) {
              wrapper.innerHTML += `<div style="color:red">‚ùå L·ªói upload: ${err}</div>`;
            } else {
              wrapper.innerHTML += `<br>‚úÖ Upload xong! <a href="${data.Location}" target="_blank">${data.Location}</a>`;
              loadFileList();
            }
          });
      });
    }

    // Hi·ªÉn th·ªã to√†n b·ªô file
    function loadFileList() {
      s3.listObjectsV2({ Bucket: bucket }, (err, data) => {
        if (err) {
          console.error("L·ªói list:", err);
          return;
        }
        const listDiv = document.getElementById("fileList");
        listDiv.innerHTML = "<h3>üìÇ File trong Bucket:</h3>";
        data.Contents.forEach(obj => {
          const url = `https://${bucket}.${endpoint}/${encodeURIComponent(obj.Key)}`;
          const item = document.createElement("div");
          item.className = "file-block";
          item.innerHTML = `
            üìÑ <a href="${url}" target="_blank">${obj.Key}</a>
            <div class="file-actions">
              <button class="btn btn-small btn-download" onclick="downloadFile('${obj.Key}')">‚¨áÔ∏è T·∫£i v·ªÅ m√°y</button>
              <button class="btn btn-small btn-rename" onclick="renameFile('${obj.Key}')">‚úèÔ∏è ƒê·ªïi t√™n</button>
              <button class="btn btn-small btn-del" onclick="deleteFile('${obj.Key}')">üóëÔ∏è X√≥a</button>
            </div>`;
          listDiv.appendChild(item);
        });
      });
    }

    // T·∫£i 1 file
    function downloadFile(key) {
      const url = `https://${bucket}.${endpoint}/${encodeURIComponent(key)}`;
      const link = document.createElement("a");
      link.href = url;
      link.download = key.split("/").pop();
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ƒê·ªïi t√™n
    function renameFile(oldKey) {
      const newName = prompt("Nh·∫≠p t√™n m·ªõi:", oldKey.split("/").pop());
      if (!newName) return;

      const newKey = Date.now() + "-" + newName;

      s3.copyObject({
        Bucket: bucket,
        CopySource: `/${bucket}/${oldKey}`,
        Key: newKey,
        ACL: "public-read"
      }, err => {
        if (err) { alert("L·ªói ƒë·ªïi t√™n: " + err); return; }

        s3.deleteObject({ Bucket: bucket, Key: oldKey }, err2 => {
          if (err2) { alert("L·ªói x√≥a file c≈©: " + err2); return; }
          alert("‚úÖ ƒê·ªïi t√™n th√†nh c√¥ng!");
          loadFileList();
        });
      });
    }

    // X√≥a file
    function deleteFile(key) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a file n√†y?")) return;
      s3.deleteObject({ Bucket: bucket, Key: key }, err => {
        if (err) { alert("L·ªói x√≥a: " + err); return; }
        alert("üóëÔ∏è ƒê√£ x√≥a!");
        loadFileList();
      });
    }

    // T·∫£i t·∫•t c·∫£ file th√†nh ZIP
    async function downloadAllAsZip() {
      s3.listObjectsV2({ Bucket: bucket }, async (err, data) => {
        if (err) { alert("Kh√¥ng th·ªÉ l·∫•y danh s√°ch file: " + err); return; }
        if (!data.Contents.length) { alert("Bucket tr·ªëng!"); return; }

        const zip = new JSZip();
        for (let obj of data.Contents) {
          const url = `https://${bucket}.${endpoint}/${encodeURIComponent(obj.Key)}`;
          try {
            const res = await fetch(url);
            const blob = await res.blob();
            zip.file(obj.Key, blob);
          } catch (e) { console.error("Kh√¥ng t·∫£i ƒë∆∞·ª£c:", obj.Key, e); }
        }
        zip.generateAsync({ type: "blob" }).then(content => {
          saveAs(content, "bucket_files.zip");
        });
      });
    }

    // T·∫£i to√†n b·ªô ·∫£nh (ZIP)
    async function downloadAllImagesZip() {
      s3.listObjectsV2({ Bucket: bucket }, async (err, data) => {
        if (err) { alert("Kh√¥ng th·ªÉ l·∫•y danh s√°ch file: " + err); return; }

        const imageExts = [".jpg", ".jpeg", ".png", ".gif", ".webp"];
        const images = data.Contents.filter(obj =>
          imageExts.some(ext => obj.Key.toLowerCase().endsWith(ext))
        );

        if (!images.length) { alert("Kh√¥ng c√≥ ·∫£nh n√†o!"); return; }

        const zip = new JSZip();
        for (let obj of images) {
          const url = `https://${bucket}.${endpoint}/${encodeURIComponent(obj.Key)}`;
          try {
            const res = await fetch(url);
            const blob = await res.blob();
            zip.file(obj.Key, blob);
          } catch (e) { console.error("Kh√¥ng t·∫£i ƒë∆∞·ª£c:", obj.Key, e); }
        }
        zip.generateAsync({ type: "blob" }).then(content => {
          saveAs(content, "all_images.zip");
        });
      });
    }

    // T·∫£i to√†n b·ªô ·∫£nh tr·ª±c ti·∫øp (kh√¥ng ZIP)
    function downloadAllImagesDirect() {
      s3.listObjectsV2({ Bucket: bucket }, (err, data) => {
        if (err) { alert("Kh√¥ng th·ªÉ l·∫•y danh s√°ch file: " + err); return; }

        const imageExts = [".jpg", ".jpeg", ".png", ".gif", ".webp"];
        const images = data.Contents.filter(obj =>
          imageExts.some(ext => obj.Key.toLowerCase().endsWith(ext))
        );

        if (!images.length) { alert("Kh√¥ng c√≥ ·∫£nh n√†o!"); return; }

        images.forEach((obj, i) => {
          setTimeout(() => {
            const url = `https://${bucket}.${endpoint}/${encodeURIComponent(obj.Key)}`;
            const link = document.createElement("a");
            link.href = url;
            link.download = obj.Key.split("/").pop();
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }, i * 500);
        });
      });
    }

    // Load khi m·ªü trang
    loadFileList();
  </script>
</body>
</html>
