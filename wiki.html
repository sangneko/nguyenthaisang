<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wiki Clean Reader</title>
  <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/6/63/Wikipedia-logo.png" />
  <style>
    :root {
      --bg-light: #f3f4f6;
      --bg-dark: #18181b;
      --card-light: #ffffff;
      --card-dark: #27272a;
      --text-light: #1f2937;
      --text-dark: #e5e7eb;
      --highlight: #2563eb;
      --highlight-hover: #1d4ed8;
      --border-radius: 8px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg-light);
      color: var(--text-light);
      padding: 40px 20px;
      margin: 0;
      transition: background 0.3s ease, color 0.3s ease;
      line-height: 1.6;
    }

    body.dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-weight: 700;
      color: var(--highlight);
    }

    .controls {
      background: var(--card-light);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      max-width: 800px;
      margin: 0 auto 30px auto;
      transition: background 0.3s ease;
    }

    body.dark .controls {
      background: var(--card-dark);
    }

    form#searchForm {
      display: flex;
      flex-direction: row;
      gap: 10px;
      width: 100%;
    }

    @media (max-width: 600px) {
      form#searchForm {
        flex-direction: column;
      }
    }

    input, select, button {
      padding: 12px 15px;
      font-size: 16px;
      border-radius: var(--border-radius);
      border: 1px solid #d1d5db;
      outline: none;
      transition: all 0.2s;
      background: #fff;
      color: #333;
    }
    
    body.dark input, body.dark select, body.dark button {
      background: #3f3f46;
      border-color: #52525b;
      color: #fff;
    }

    input { flex-grow: 1; }
    select { width: auto; min-width: 150px; cursor: pointer; }

    input:focus, select:focus {
      border-color: var(--highlight);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    button {
      cursor: pointer;
      font-weight: 600;
    }

    button[type="submit"] {
      background-color: var(--highlight);
      color: white;
      border: none;
      min-width: 100px;
    }
    button[type="submit"]:hover {
      background-color: var(--highlight-hover);
      transform: translateY(-1px);
    }

    #themeToggle {
      margin-top: 10px;
      width: 100%;
      background: transparent;
      border: 1px dashed #9ca3af;
      color: inherit;
    }
    #themeToggle:hover {
      border-color: var(--highlight);
      color: var(--highlight);
    }

    #results {
      max-width: 800px;
      margin: auto;
      background: var(--card-light);
      border-radius: var(--border-radius);
      padding: 30px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      display: none;
    }
    body.dark #results {
      background: var(--card-dark);
    }

    img.thumbnail {
      float: left;
      margin-right: 20px;
      margin-bottom: 10px;
      max-width: 150px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .quote {
      background: rgba(37, 99, 235, 0.1);
      padding: 20px;
      border-left: 4px solid var(--highlight);
      margin: 20px 0;
      border-radius: 0 var(--border-radius) var(--border-radius) 0;
      font-style: italic;
      font-size: 1.1em;
    }
    body.dark .quote {
      background: rgba(37, 99, 235, 0.15);
    }

    .last-edited {
      font-size: 0.85em;
      color: #6b7280;
      margin-top: 15px;
      clear: both;
      border-top: 1px solid #e5e7eb;
      padding-top: 10px;
    }

    .fav-btn {
      background: #ef4444;
      color: white;
      border: none;
      width: auto;
      display: inline-block;
      margin-top: 10px;
    }
    .fav-btn:hover { background: #dc2626; }

    .favorites {
      margin-top: 40px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    
    #filterFav {
      margin-bottom: 15px;
    }

    #favList li {
      background: var(--card-light);
      padding: 15px;
      margin-bottom: 10px;
      border-radius: var(--border-radius);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-left: 4px solid #ef4444;
      list-style: none;
    }
    body.dark #favList li {
      background: var(--card-dark);
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 10px;
    }
    
    .tab-buttons button {
      width: auto;
      background: transparent;
      border: none;
      color: #6b7280;
      padding: 8px 16px;
      border-radius: var(--border-radius);
    }
    
    .tab-buttons button:hover {
      background: #f3f4f6;
      color: var(--highlight);
      transform: none;
    }
    
    body.dark .tab-buttons button:hover {
      background: #3f3f46;
    }

    /* --- CLEANER CSS --- */
    /* ·∫®n c√°c class r√°c c·ªßa wiki b·∫±ng CSS ƒë·ªÉ ƒë·∫£m b·∫£o */
    .reference, .reflist, .mw-references-wrap, .mw-editsection, 
    .hatnote, .ambox, .navbox, .catlinks, .authority-control, .portal, .printfooter {
        display: none !important;
    }

    /* Style l·∫°i link trong ph·∫ßn chi ti·∫øt: B·ªè g·∫°ch ch√¢n, b·ªè m√†u xanh */
    #detailTab a {
        text-decoration: none !important;
        color: inherit !important;
        pointer-events: none;
        cursor: text;
    }

    #detailTab img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
        margin: 10px 0;
    }

  </style>
</head>
<body>

  <h1>üîç Wiki Clean Reader</h1>

  <div class="controls">
    <form id="searchForm">
      <input type="text" id="searchInput" placeholder="Nh·∫≠p t·ª´ kh√≥a..." required />
      <select id="langSelect">
        <optgroup label="Ph·ªï bi·∫øn nh·∫•t">
            <option value="vi">Ti·∫øng Vi·ªát</option>
            <option value="en">English</option>
            <option value="zh">‰∏≠Êñá</option>
            <option value="es">Espa√±ol</option>
            <option value="ja">Êó•Êú¨Ë™û</option>
            <option value="fr">Fran√ßais</option>
            <option value="de">Deutsch</option>
            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
            <option value="ko">ÌïúÍµ≠Ïñ¥</option>
        </optgroup>
        <optgroup label="Ch√¢u √Å & Kh√°c">
            <option value="th">‡πÑ‡∏ó‡∏¢</option>
            <option value="id">Indonesia</option>
            <option value="ms">Melayu</option>
            <option value="it">Italiano</option>
            <option value="pt">Portugu√™s</option>
        </optgroup>
      </select>
      <button type="submit">T√¨m ki·∫øm</button>
    </form>
    <button onclick="toggleTheme()" id="themeToggle">üåô Ch·∫ø ƒë·ªô t·ªëi</button>
  </div>

  <div id="results">
    <div class="tab-buttons">
      <button onclick="showTab('summary')">üìÑ T√≥m t·∫Øt</button>
      <button onclick="showTab('detail')">üìö Chi ti·∫øt</button>
    </div>
    <div id="summaryTab"></div>
    <div id="detailTab" style="display:none;"></div>
  </div>

  <div class="favorites">
    <h2>‚ù§Ô∏è Tr√≠ch d·∫´n ƒë√£ l∆∞u</h2>
    <input type="text" id="filterFav" placeholder="L·ªçc danh s√°ch ƒë√£ l∆∞u..." />
    <ul id="favList"></ul>
  </div>

  <script>
    const form = document.getElementById('searchForm');
    const searchInput = document.getElementById('searchInput');
    const langSelect = document.getElementById('langSelect');
    const summaryTab = document.getElementById('summaryTab');
    const detailTab = document.getElementById('detailTab');
    const favList = document.getElementById('favList');
    const resultsDiv = document.getElementById('results');

    langSelect.addEventListener('change', () => {
        if(searchInput.value.trim() !== "") {
            searchWiki(searchInput.value.trim(), langSelect.value);
        }
    });

    function toggleTheme() {
      document.body.classList.toggle('dark');
    }

    function showTab(tab) {
      summaryTab.style.display = tab === 'summary' ? 'block' : 'none';
      detailTab.style.display = tab === 'detail' ? 'block' : 'none';
    }

    function saveFavorite(title, extract) {
      const favs = JSON.parse(localStorage.getItem('favorites') || '[]');
      if(!favs.some(f => f.title === title)) {
          favs.push({ title, extract });
          localStorage.setItem('favorites', JSON.stringify(favs));
          loadFavorites();
      } else {
          alert('ƒê√£ l∆∞u r·ªìi!');
      }
    }

    function loadFavorites() {
      const favs = JSON.parse(localStorage.getItem('favorites') || '[]');
      favList.innerHTML = '';
      if (favs.length === 0) {
          favList.innerHTML = '<p style="text-align:center; color:gray">Ch∆∞a c√≥ m·ª•c n√†o.</p>';
          return;
      }
      favs.reverse().forEach(fav => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${fav.title}</strong><br><span style="font-size:0.9em; opacity:0.8">${fav.extract}</span>`;
        favList.appendChild(li);
      });
    }

    document.getElementById('filterFav').addEventListener('input', function () {
      const keyword = this.value.toLowerCase();
      const lis = favList.querySelectorAll('li');
      lis.forEach(li => {
        li.style.display = li.textContent.toLowerCase().includes(keyword) ? 'block' : 'none';
      });
    });

    // --- H√ÄM D·ªåN D·∫∏P M·∫†NH M·∫º ---
    function cleanWikiContent(htmlContent) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlContent;

        // 1. X√≥a c√°c class r√°c th√¥ng th∆∞·ªùng (Navbox, Category, Refs)
        const junkSelectors = [
            'sup.reference', '.reflist', '.refbegin', '.mw-references-wrap', 
            '.mw-editsection', '.ambox', '.hatnote', '.navbox', 
            '.catlinks', '.authority-control', '.portal', '.printfooter',
            '.sistersitebox' // H·ªôp d·ª± √°n anh em
        ];
        tempDiv.querySelectorAll(junkSelectors.join(', ')).forEach(el => el.remove());

        // 2. X√≥a c√°c Section "Li√™n k·∫øt ngo√†i", "Xem th√™m", "ƒê·ªçc th√™m"
        // (T√¨m H2 ch·ª©a ID/Text x·∫•u -> X√≥a H2 v√† n·ªôi dung b√™n d∆∞·ªõi cho ƒë·∫øn H2 ti·∫øp theo)
        const headers = tempDiv.querySelectorAll('h2');
        
        // Danh s√°ch ID/T·ª´ kh√≥a c·∫ßn x√≥a (bao g·ªìm c·∫£ ti·∫øng Anh v√† Vi·ªát ph·ªï bi·∫øn)
        const badKeywords = [
            'External_links', 'See_also', 'Further_reading', 'Notes', 'References', // Ti·∫øng Anh
            'Li√™n_k·∫øt_ngo√†i', 'Xem_th√™m', 'ƒê·ªçc_th√™m', 'Tham_kh·∫£o', 'Ch√∫_th√≠ch'      // Ti·∫øng Vi·ªát
        ];

        headers.forEach(h2 => {
            const headline = h2.querySelector('.mw-headline');
            // Ki·ªÉm tra xem ID c·ªßa headline c√≥ ch·ª©a t·ª´ kh√≥a x·∫•u kh√¥ng
            if (headline && badKeywords.some(key => headline.id.includes(key))) {
                
                // B·∫Øt ƒë·∫ßu x√≥a t·ª´ H2 n√†y
                let currentNode = h2;
                // X√≥a ti·∫øp c√°c anh em (siblings) ph√≠a sau cho ƒë·∫øn khi g·∫∑p H2 kh√°c ho·∫∑c h·∫øt b√†i
                while (currentNode) {
                    let nextNode = currentNode.nextElementSibling;
                    currentNode.remove();
                    
                    // N·∫øu node ti·∫øp theo l√† H2 th√¨ d·ª´ng l·∫°i (ƒë√£ sang ph·∫ßn kh√°c)
                    if (nextNode && nextNode.tagName === 'H2') break;
                    
                    currentNode = nextNode;
                }
            }
        });

        return tempDiv.innerHTML;
    }

    async function searchWiki(term, lang) {
      resultsDiv.style.display = 'block';
      summaryTab.innerHTML = `<p style="text-align:center">‚è≥ ƒêang t·∫£i (${lang})...</p>`;
      detailTab.innerHTML = "";

      try {
        const summaryRes = await fetch(`https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(term)}`);
        
        if (!summaryRes.ok) throw new Error('Not found');

        const summary = await summaryRes.json();

        const metaRes = await fetch(`https://${lang}.wikipedia.org/w/api.php?action=query&prop=revisions&rvprop=timestamp&format=json&origin=*&titles=${encodeURIComponent(term)}`);
        const metaData = await metaRes.json();
        const pageId = Object.keys(metaData.query.pages)[0];
        const lastEdited = metaData.query.pages[pageId]?.revisions?.[0]?.timestamp || "Kh√¥ng r√µ";

        const fullRes = await fetch(`https://${lang}.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(term)}&format=json&origin=*`);
        const fullData = await fullRes.json();

        const safeTitle = summary.title.replace(/'/g, "\\'");
        const safeExtract = summary.extract.replace(/'/g, "\\'").replace(/\n/g, " ");
        
        // G·ªçi h√†m d·ªçn d·∫πp m·ªõi
        const cleanedDetail = cleanWikiContent(fullData.parse?.text["*"] || "");

        summaryTab.innerHTML = `
          <h2 style="margin-top:0">${summary.title}</h2>
          ${summary.thumbnail ? `<a href="${summary.content_urls.desktop.page}" target="_blank"><img src="${summary.thumbnail.source}" class="thumbnail" alt="${summary.title}" /></a>` : ''}
          <div class="quote">${summary.extract}</div>
          <div class="last-edited">üïì S·ª≠a l·∫ßn cu·ªëi: ${new Date(lastEdited).toLocaleString('vi-VN')}</div>
          <button class="fav-btn" onclick="saveFavorite('${safeTitle}', '${safeExtract}')">‚ù§Ô∏è L∆∞u tr√≠ch d·∫´n</button>
          <div style="clear:both"></div>
        `;

        detailTab.innerHTML = `
          <h3>N·ªôi dung chi ti·∫øt</h3>
          <div style="overflow-x:auto">${cleanedDetail || "Kh√¥ng t√¨m th·∫•y n·ªôi dung chi ti·∫øt."}</div>
        `;

        showTab('summary');

      } catch (e) {
        summaryTab.innerHTML = `<p style="text-align:center; color: #d32f2f">‚ùå Kh√¥ng t√¨m th·∫•y. Th·ª≠ ƒë·ªïi ng√¥n ng·ªØ ho·∫∑c t·ª´ kh√≥a kh√°c.</p>`;
        detailTab.innerHTML = '';
      }
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const term = searchInput.value.trim();
      const lang = langSelect.value;
      if (term) searchWiki(term, lang);
    });

    loadFavorites();
  </script>
</body>
</html>
